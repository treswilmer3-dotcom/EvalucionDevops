---
- name: ConfiguraciÃ³n bÃ¡sica de terminales - Hostname y actualizaciÃ³n
  hosts: terminales
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Mostrar objetivo del playbook
      debug:
        msg: "ğŸ¯ Configurando: {{ inventory_hostname }} - Hostname y actualizaciÃ³n del sistema"
      
    # Tarea 1: ConfiguraciÃ³n de hostname usando mÃ³dulos nativos
    - name: Configurar hostname en terminal-1
      hostname:
        name: terminal1
      when: inventory_hostname == "terminal-1"
      
    - name: Configurar hostname en terminal-2
      hostname:
        name: terminal2
      when: inventory_hostname == "terminal-2"
      
    - name: Configurar hostname en terminal-3
      hostname:
        name: terminal3
      when: inventory_hostname == "terminal-3"
      
    - name: Configurar hostname en terminal-4
      hostname:
        name: terminal4
      when: inventory_hostname == "terminal-4"
      
    - name: Mostrar cambio de hostname
      debug:
        msg: "ğŸ–¥ï¸  Hostname cambiado a: {{ ansible_hostname }}"
      
    # Tarea 2: ActualizaciÃ³n del sistema usando mÃ³dulo yum (idempotente)
    - name: Actualizar repositorios del sistema
      yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"
      register: repo_update
      
    - name: Mostrar estado de actualizaciÃ³n de repos
      debug:
        msg: "ğŸ“¦ Repositorios: {{ 'Actualizados' if repo_update.changed else 'Sin cambios' }}"
      
    - name: Actualizar todos los paquetes del sistema
      yum:
        name: '*'
        state: latest
      when: ansible_os_family == "RedHat"
      register: system_update
      
    - name: Mostrar resultado de actualizaciÃ³n
      debug:
        msg: "ğŸ”„ Sistema actualizado: {{ 'SÃ­' if system_update.changed else 'No actualizaciones necesarias' }}"
      
    # Tarea 3: VerificaciÃ³n post-configuraciÃ³n
    - name: Verificar hostname actual
      command: hostname
      register: current_hostname
      changed_when: false
      
    - name: Mostrar hostname configurado
      debug:
        msg: "âœ… Hostname verificado: {{ current_hostname.stdout }}"
      
    - name: Verificar informaciÃ³n del sistema post-actualizaciÃ³n
      setup:
        gather_subset:
          - distribution
          - hardware
      register: system_info
      
    - name: Mostrar resumen de configuraciÃ³n
      debug:
        msg: |
          ğŸ“‹ RESUMEN DE CONFIGURACIÃ“N - {{ current_hostname.stdout }}
          ==========================================
          ğŸ–¥ï¸  Hostname: {{ current_hostname.stdout }}
          ğŸŒ IP: {{ ansible_default_ipv4.address }}
          ğŸ’¾ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ§  RAM: {{ ansible_memtotal_mb }}MB
          âš¡ CPU: {{ ansible_processor_cores }} cores
          ğŸ”„ ActualizaciÃ³n: {{ 'Completada' if system_update.changed else 'No requerida' }}
          ğŸ“… Fecha: {{ ansible_date_time.date }}
          â° Hora: {{ ansible_date_time.time }}
          ==========================================
          âœ… ConfiguraciÃ³n bÃ¡sica finalizada
      
    # Tarea 4: Instalar herramientas bÃ¡sicas de administraciÃ³n
    - name: Instalar herramientas de administraciÃ³n bÃ¡sicas
      yum:
        name:
          - vim
          - curl
          - wget
          - tree
          - git
        state: present
      when: ansible_os_family == "RedHat"
      register: tools_install
      
    - name: Mostrar instalaciÃ³n de herramientas
      debug:
        msg: "ğŸ› ï¸  Herramientas instaladas: {{ 'SÃ­' if tools_install.changed else 'Ya existÃ­an' }}"
      
    # Tarea 5: Crear archivo de configuraciÃ³n para referencia
    - name: Crear archivo de configuraciÃ³n del laboratorio
      copy:
        content: |
          # CONFIGURACIÃ“N LABORATORIO ANSIBLE
          # ==========================================
          # Hostname: {{ current_hostname.stdout }}
          # IP: {{ ansible_default_ipv4.address }}
          # OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          # Configurado por: Ansible
          # Fecha: {{ ansible_date_time.iso8601 }}
          # Playbook: 03-configuracion-basica.yml
          # ==========================================
          # Este archivo indica que la configuraciÃ³n bÃ¡sica
          # del laboratorio ha sido aplicada exitosamente.
        dest: /etc/ansible-lab-configured
        owner: root
        group: root
        mode: '0644'
      
    - name: Verificar archivo de configuraciÃ³n
      stat:
        path: /etc/ansible-lab-configured
      register: config_file
      
    - name: Confirmar archivo de configuraciÃ³n
      debug:
        msg: "ğŸ“„ Archivo de configuraciÃ³n creado: {{ config_file.stat.path }}"

- name: Resumen final del playbook
  hosts: localhost
  gather_facts: no
  
  tasks:
    - name: Mostrar resumen completo
      debug:
        msg: |
          ğŸ‰ PLAYBOOK 3 COMPLETADO
          ==========================================
          âœ… Hostnames configurados:
             - terminal-1 â†’ terminal1
             - terminal-2 â†’ terminal2  
             - terminal-3 â†’ terminal3
             - terminal-4 â†’ terminal4
          
          âœ… Sistemas actualizados
          âœ… Herramientas de administraciÃ³n instaladas
          âœ… Archivos de configuraciÃ³n creados