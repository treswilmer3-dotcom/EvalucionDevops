---
- name: Setup inicial del laboratorio Ansible
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Actualizar todos los paquetes
      yum:
        name: '*'
        state: latest
        update_only: yes
      
    - name: Instalar paquetes básicos
      yum:
        name:
          - git
          - vim
          - curl
          - wget
          - htop
          - tree
        state: present

    - name: Crear usuario ansible si no existe
      user:
        name: ansible
        state: present
        create_home: yes
        shell: /bin/bash

    - name: Configurar sudo para usuario ansible
      lineinfile:
        path: /etc/sudoers.d/ansible
        line: 'ansible ALL=(ALL) NOPASSWD: ALL'
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

- name: Configurar Ansible Master
  hosts: ansible_master
  become: yes
  
  tasks:
    - name: Instalar Ansible
      yum:
        name: ansible
        state: present

    - name: Crear directorio de configuración Ansible
      file:
        path: /etc/ansible
        state: directory
        mode: '0755'

    - name: Copiar archivo de configuración ansible.cfg
      copy:
        content: |
          [defaults]
          inventory = /etc/ansible/hosts
          host_key_checking = False
          retry_files_enabled = False
          roles_path = /etc/ansible/roles
          
          [ssh_connection]
          ssh_args = -o ControlMaster=auto -o ControlPersist=60s
        dest: /etc/ansible/ansible.cfg
        mode: '0644'

    - name: Generar par de claves SSH para Ansible
      user:
        name: ec2-user
        generate_ssh_key: yes
        ssh_key_bits: 2048
        ssh_key_file: .ssh/id_rsa_ansible

    - name: Copiar clave pública a authorized_keys
      shell: |
        cat /home/ec2-user/.ssh/id_rsa_ansible.pub >> /home/ec2-user/.ssh/authorized_keys
        chmod 600 /home/ec2-user/.ssh/authorized_keys

- name: Configurar terminales
  hosts: terminales
  become: yes
  
  tasks:
    - name: Instalar paquetes adicionales para terminales
      yum:
        name:
          - docker
          - python3
          - python3-pip
        state: present

    - name: Iniciar y habilitar Docker
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Agregar usuario ec2-user al grupo docker
      user:
        name: ec2-user
        groups: docker
        append: yes
